<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<artifactId>splice_machine_test-mapr4.0</artifactId>
	<packaging>jar</packaging>
	<name>${project.artifactId}</name>
	<description>Splice Machine Test</description>
	<parent>
		<artifactId>spliceengine-mapr4.0</artifactId>
		<groupId>com.splicemachine</groupId>
		<version>1.1.0-SNAPSHOT</version>
	</parent>
	<properties>
		<sparkMasterIP>localhost</sparkMasterIP>
		<sparkMasterPort>7077</sparkMasterPort>
		<sparkMasterWebUIPort>8080</sparkMasterWebUIPort>
		<sparkMasterURL>local[8]</sparkMasterURL>
		<splice.spark.enabled>false</splice.spark.enabled>
	</properties>
	<dependencies>
		<dependency>
			<groupId>com.splicemachine</groupId>
			<artifactId>splice_machine_adapter_98-mapr4.0</artifactId>
			<version>1.1.0-SNAPSHOT</version>
		</dependency>
		<dependency>
			<groupId>com.splicemachine</groupId>
			<artifactId>splice_machine_adapter_98-mapr4.0</artifactId>
			<version>1.1.0-SNAPSHOT</version>
			<classifier>tests</classifier>
		</dependency>
	</dependencies>
	<profiles>
		<profile>
			<id>ITs</id>
			<properties>
				<!-- enable failsafe integration tests -->
				<skip.integration.tests>false</skip.integration.tests>
				<server.start.skip>skipServerStart</server.start.skip>
				<!-- skip server start/stop if server already running -->
				<!-- ant task start/stop server args -->
				<run.command>/bin/bash</run.command>
				<splice.start.script>${project.basedir}/src/test/bin/start-splice-its</splice.start.script>
				<splice.stop.script>${project.basedir}/src/test/bin/stop-splice-its</splice.stop.script>
			</properties>
			<build>
				<plugins>
					<plugin>
						<artifactId>maven-antrun-plugin</artifactId>
						<executions>
							<execution>
								<id>############### start-splice-its ###############</id>
								<phase>pre-integration-test</phase>
								<configuration>
									<target name="StartSpliceServer" unless="${server.start.skip}">
										<taskdef resource="net/sf/antcontrib/antcontrib.properties" classpathref="maven.plugin.classpath"/>
										<if>
											<istrue value="${failTasksRandomly}"/>
											<!-- run with chaos monkey (default) -->
											<then>
												<exec executable="${run.command}" dir="${basedir}" spawn="false">
													<arg value="${splice.start.script}"/>
													<arg value="-c"/>
													<arg value="-p ${envClassifier}"/>
												</exec>
											</then>
											<else>
												<!-- chaos monkey overridden: -DfailTasksRandomly=false -->
												<exec executable="${run.command}" dir="${basedir}" spawn="false">
													<arg value="${splice.start.script}"/>
													<arg value="-p ${envClassifier}"/>
												</exec>
											</else>
										</if>
									</target>
								</configuration>
								<goals>
									<goal>run</goal>
								</goals>
							</execution>
							<execution>
								<id>############### stop-splice-its ###############</id>
								<phase>post-integration-test</phase>
								<configuration>
									<target name="StopSpliceServer" unless="${server.start.skip}">
										<exec executable="${run.command}" dir="${basedir}" spawn="false">
											<arg value="${splice.stop.script}"/>
										</exec>
									</target>
								</configuration>
								<goals>
									<goal>run</goal>
								</goals>
							</execution>
						</executions>
						<dependencies>
							<dependency>
								<groupId>ant-contrib</groupId>
								<artifactId>ant-contrib</artifactId>
								<version>1.0b3</version>
								<exclusions>
									<exclusion>
										<groupId>ant</groupId>
										<artifactId>ant</artifactId>
									</exclusion>
								</exclusions>
							</dependency>
							<dependency>
								<groupId>org.apache.ant</groupId>
								<artifactId>ant-nodeps</artifactId>
								<version>1.8.1</version>
							</dependency>
						</dependencies>
					</plugin>
					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>exec-maven-plugin</artifactId>
						<executions>
							<execution>
								<phase>pre-integration-test</phase>
								<goals>
									<goal>java</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<mainClass>com.splicemachine.test.SpliceTestPlatformWait</mainClass>
							<arguments>
								<argument>localhost</argument>
								<argument>1527</argument>
							</arguments>
						</configuration>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>assemble</id>
			<build>
				<plugins>
					<plugin>
						<artifactId>maven-assembly-plugin</artifactId>
						<configuration>
							<archive>
								<manifestEntries>
									<Implementation-Version>${buildNumber}</Implementation-Version>
									<Release>${project.version}</Release>
									<Build-Time>${maven.build.timestamp}</Build-Time>
									<URL>http://www.splicemachine.com</URL>
								</manifestEntries>
							</archive>
							<finalName>splice_machine-${project.version}</finalName>
							<descriptors>
								<descriptor>${project.basedir}/src/main/assembly/assembly.xml</descriptor>
								<descriptor>${project.basedir}/src/main/assembly/standalone_assembly.xml</descriptor>
							</descriptors>
							<attach>true</attach>
						</configuration>
						<executions>
							<execution>
								<phase>package</phase>
								<id>simple</id>
								<goals>
									<goal>single</goal>
								</goals>
							</execution>
						</executions>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>spliceZoo</id>
			<activation>
				<property>
					<name>zoo</name>
				</property>
			</activation>
			<build>
				<plugins>
					<plugin>
						<artifactId>maven-clean-plugin</artifactId>
						<executions>
							<execution>
								<goals>
									<goal>clean</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<excludeDefaultDirectories>true</excludeDefaultDirectories>
							<filesets>
								<fileset>
									<directory>${project.build.directory}/hbase</directory>
									<includes>
										<include>**/*</include>
									</includes>
								</fileset>
								<fileset>
									<directory>${project.build.directory}/zookeeper</directory>
									<includes>
										<include>**/*</include>
									</includes>
								</fileset>
							</filesets>
						</configuration>
					</plugin>
					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>exec-maven-plugin</artifactId>
						<executions>
							<execution>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<classpathScope>compile</classpathScope>
							<executable>java</executable>
							<arguments>
								<argument>-cp</argument>
								<classpath>${maven.runtime.classpath}</classpath>
								<argument>-Djava.awt.headless=true</argument>
								<argument>-Dlog4j.configuration=file:${basedir}/src/main/resources/info-log4j.properties</argument>
								<argument>-Djava.net.preferIPv4Stack=true</argument>
								<argument>-Dzookeeper.sasl.client=false</argument>
								<argument>-Xmx2g</argument>
								<argument>-Xms1g</argument>
								<argument>-XX:MaxPermSize=256M</argument>
								<argument>-XX:+CMSClassUnloadingEnabled</argument>
								<argument>-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=4002</argument>
								<argument>org.apache.zookeeper.server.ZooKeeperServerMain</argument>
								<argument>2181</argument>
								<argument>${project.build.directory}/zookeeper</argument>
								<argument>10</argument>
								<argument>0</argument>
							</arguments>
						</configuration>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>spliceClusterMember</id>
			<activation>
				<property>
					<name>spliceClusterMember</name>
				</property>
			</activation>
			<properties>
				<memberNumber>1</memberNumber>
			</properties>
			<build>
				<plugins>
					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>exec-maven-plugin</artifactId>
						<executions>
							<execution>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<classpathScope>compile</classpathScope>
							<executable>java</executable>
							<arguments>
								<argument>-cp</argument>
								<classpath>${maven.runtime.classpath}</classpath>
								<argument>-Djava.awt.headless=true</argument>
								<argument>-Dlog4j.configuration=${log4j.config.uri}</argument>
								<argument>-Djava.net.preferIPv4Stack=true</argument>
								<argument>-Xmx2g</argument>
								<argument>-Xmn128m</argument>
								<argument>-XX:+UseConcMarkSweepGC</argument>
								<argument>-XX:+UseParNewGC</argument>
								<argument>-XX:NewSize=128m</argument>
								<argument>-XX:MaxNewSize=128m</argument>
								<argument>-XX:CMSInitiatingOccupancyFraction=70</argument>
								<argument>-XX:+UseCMSInitiatingOccupancyOnly</argument>
								<argument>-XX:MaxGCPauseMillis=100</argument>
								<argument>-XX:MaxPermSize=256M</argument>
								<argument>-XX:+CMSClassUnloadingEnabled</argument>
								<argument>-XX:MaxDirectMemorySize=1g</argument>
								<argument>com.splicemachine.test.SpliceTestClusterParticipant</argument>
								<argument>${project.build.directory}/hbase</argument>
								<argument>${memberNumber}</argument>
							</arguments>
						</configuration>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>spliceFast</id>
			<activation>
				<property>
					<name>spliceFast</name>
				</property>
			</activation>
			<build>
				<plugins>
					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>exec-maven-plugin</artifactId>
						<executions>
							<execution>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<classpathScope>compile</classpathScope>
							<executable>java</executable>
							<arguments>
								<!-- <argument>-verbose:gc</argument> -->
								<argument>-cp</argument>
								<classpath>${maven.runtime.classpath}</classpath>
								<argument>-Xdebug</argument>
								<argument>-Dlog4j.configuration=${log4j.config.uri}</argument>
								<argument>-Djava.net.preferIPv4Stack=true</argument>
								<argument>-Djava.awt.headless=true</argument>
								<argument>-Dzookeeper.sasl.client=false</argument>
								<argument>-Dcom.sun.management.jmxremote.ssl=false</argument>
								<argument>-Dcom.sun.management.jmxremote.authenticate=false</argument>
								<argument>-Dcom.sun.management.jmxremote.port=10102</argument>
								<argument>-Dsplice.authentication=NATIVE</argument>
								<argument>-Dsplice.spark.master=${sparkMasterURL}</argument>
								<argument>-Dsplice.spark.enabled=${splice.spark.enabled}</argument>
								<argument>-Xmx8g</argument>
								<argument>-Xms1g</argument>
								<!-- G1 Garbage Collection -->
								<!--
								<argument>-XX:MaxPermSize=256M</argument>
								<argument>-XX:MaxDirectMemorySize=1g</argument>
								<argument>-XX:+UseG1GC</argument>
								<argument>-XX:MaxGCPauseMillis=100</argument>
								<argument>-XX:InitiatingHeapOccupancyPercent=50</argument>
								<argument>-XX:+ParallelRefProcEnabled</argument>
								<argument>-XX:-ResizePLAB</argument>
								<argument>-XX:ParallelGCThreads=8</argument>
								<argument>-XX:+PrintGCTimeStamps</argument>
								<argument>-XX:+PrintGCDetails</argument>
-->
								<!-- CMS Garbage Collection -->
								<argument>-Xmn128m</argument>
								<argument>-XX:+UseConcMarkSweepGC</argument>
								<argument>-XX:+UseParNewGC</argument>
								<argument>-XX:NewSize=128m</argument>
								<argument>-XX:MaxNewSize=128m</argument>
								<argument>-XX:CMSInitiatingOccupancyFraction=70</argument>
								<argument>-XX:+UseCMSInitiatingOccupancyOnly</argument>
								<argument>-XX:MaxGCPauseMillis=100</argument>
								<argument>-XX:MaxPermSize=256M</argument>
								<argument>-XX:+CMSClassUnloadingEnabled</argument>
								<argument>-XX:MaxDirectMemorySize=1g</argument>
								<argument>-enableassertions</argument>
								<argument>-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=4000</argument>
								<!-- Setting the updateSystemProcs option to true causes all of the system stored procedures to be re-created on server startup. -->
								<argument>-Dderby.language.updateSystemProcs=false</argument>
								<!-- Setting the logStatementText option to true enables logging of all statements. -->
								<argument>-Dderby.language.logStatementText=false</argument>
								<argument>com.splicemachine.test.SpliceTestPlatform</argument>
								<argument>file://${project.build.directory}/hbase</argument>
								<argument>60000</argument>
								<argument>60010</argument>
								<argument>60020</argument>
								<argument>60030</argument>
								<argument>1527</argument>
								<argument>${failTasksRandomly}</argument>
							</arguments>
						</configuration>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>spliceWait</id>
			<build>
				<plugins>
					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>exec-maven-plugin</artifactId>
						<executions>
							<execution>
								<goals>
									<goal>java</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<mainClass>com.splicemachine.test.SpliceTestPlatformWait</mainClass>
							<arguments>
								<argument>localhost</argument>
								<argument>1527</argument>
							</arguments>
						</configuration>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>ij</id>
			<activation>
				<property>
					<name>ij</name>
				</property>
			</activation>
			<properties>
				<ij.connection.port>1527</ij.connection.port>
				<!-- Override from command line with -Dij.connection.port=1528 -->
			</properties>
			<build>
				<plugins>
					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>exec-maven-plugin</artifactId>
						<executions>
							<execution>
								<goals>
									<goal>java</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<systemProperties>
								<systemProperty>
									<key>ij.connection.splice</key>
									<value>jdbc:splice://localhost:${ij.connection.port}/splicedb;user=splice;password=admin</value>
								</systemProperty>
							</systemProperties>
							<mainClass>org.apache.derby.tools.ij</mainClass>
							<includeProjectDependencies>true</includeProjectDependencies>
							<executable>maven</executable>
						</configuration>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>spark-prepare</id>
			<activation>
				<property>
					<name>spark-prepare</name>
				</property>
			</activation>
			<build>
				<plugins>
					<plugin>
						<groupId>org.apache.maven.plugins</groupId>
						<artifactId>maven-dependency-plugin</artifactId>
						<version>2.10</version>
						<executions>
							<execution>
								<id>copy</id>
								<phase>package</phase>
								<goals>
									<goal>copy-dependencies</goal>
								</goals>
							</execution>
						</executions>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>spark-master</id>
			<activation>
				<property>
					<name>spark-master</name>
				</property>
			</activation>
			<build>
				<plugins>
					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>exec-maven-plugin</artifactId>
						<executions>
							<execution>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<classpathScope>compile</classpathScope>
							<executable>java</executable>
							<arguments>
								<argument>-cp</argument>
								<classpath>${maven.runtime.classpath}</classpath>
								<argument>-Djava.awt.headless=true</argument>
								<argument>-Dlog4j.configuration=file:${basedir}/src/main/resources/info-log4j.properties</argument>
								<argument>-Djava.net.preferIPv4Stack=true</argument>
								<argument>-Dzookeeper.sasl.client=false</argument>
								<argument>-Xmx5g</argument>
								<argument>-Xms1g</argument>
								<argument>-XX:MaxPermSize=256M</argument>
								<argument>-XX:+CMSClassUnloadingEnabled</argument>
								<argument>-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=4003</argument>
								<argument>org.apache.spark.deploy.master.Master</argument>
								<argument>--ip</argument>
								<argument>${sparkMasterIP}</argument>
								<argument>--port</argument>
								<argument>${sparkMasterPort}</argument>
								<argument>--webui-port</argument>
								<argument>${sparkMasterWebUIPort}</argument>
							</arguments>
						</configuration>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>spark-worker</id>
			<activation>
				<property>
					<name>spark-worker</name>
				</property>
			</activation>
			<build>
				<plugins>
					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>exec-maven-plugin</artifactId>
						<executions>
							<execution>
								<goals>
									<goal>exec</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<classpathScope>compile</classpathScope>
							<executable>java</executable>
							<arguments>
								<argument>-cp</argument>
								<classpath>${maven.runtime.classpath}</classpath>
								<argument>-Djava.awt.headless=true</argument>
								<argument>-Dlog4j.configuration=file:${basedir}/src/main/resources/info-log4j.properties</argument>
								<argument>-Djava.net.preferIPv4Stack=true</argument>
								<argument>-Dzookeeper.sasl.client=false</argument>
								<argument>-Xmx5g</argument>
								<argument>-Xms1g</argument>
								<argument>-XX:MaxPermSize=256M</argument>
								<argument>-XX:+CMSClassUnloadingEnabled</argument>
								<argument>-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=4004</argument>
								<argument>org.apache.spark.deploy.worker.Worker</argument>
								<argument>spark://${sparkMasterIP}:${sparkMasterPort}</argument>
							</arguments>
						</configuration>
					</plugin>
				</plugins>
			</build>
		</profile>
	</profiles>
</project>
