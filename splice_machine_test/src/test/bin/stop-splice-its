#!/bin/bash

##################################################################################
# Stop Zookeeper and the Splice HBase servers
# See usage() below.
##################################################################################

# Check if server running. If not, no need to proceed.
yarn_pids=( $(ps -ef | awk '/PspliceYarn|CoarseGrainedScheduler|ExecutorLauncher/ && !/awk/ {print $2}') )
splice_pids=( $(ps -ef | awk '/SpliceTestPlatform|SpliceSinglePlatform|SpliceTestClusterParticipant/ && !/awk/ {print $2}') )
zoo_pids=( $(ps -ef | awk '/ZooKeeperServerMain/ && !/awk/ {print $2}') )
if [[ -z ${yarn_pids[0]} && -z ${splice_pids[0]} && -z ${zoo_pids[0]} ]]; then
    echo "Splice server is not running."
    exit 0
else
	# otherwise kill it nicely
	SIG=15
	[[ -n ${yarn_pids[0]} ]] && echo "Found Yarn. Stopping it." && for pid in ${yarn_pids[@]}; do kill -${SIG} $(echo ${pid}); done
	[[ -n ${splice_pids[0]} ]] && echo "Found Splice. Stopping it." && for pid in ${splice_pids[@]}; do kill -${SIG} $(echo ${pid}); done
	[[ -n ${zoo_pids[0]} ]] && echo "Found ZooKeeper. Stopping it." && for pid in ${zoo_pids[@]}; do kill -${SIG} $(echo ${pid}); done
fi
sleep 20 # give them time to die

# Check for stragglers and kill 'em dead
SIG=9
yarn_pids9=( $(ps -ef | awk '/PspliceYarn|CoarseGrainedScheduler|ExecutorLauncher/ && !/awk/ {print $2}') )
splice_pids9=( $(ps -ef | awk '/SpliceTestPlatform|SpliceSinglePlatform|SpliceTestClusterParticipant/ && !/awk/ {print $2}') )
zoo_pids9=( $(ps -ef | awk '/ZooKeeperServerMain/ && !/awk/ {print $2}') )
[[ -n ${yarn_pids9[0]} ]] && echo "Found Yarn straggler. Stopping it." && for pid in ${yarn_pids9[@]}; do kill -${SIG} $(echo ${pid}); done
[[ -n ${splice_pids9[0]} ]] && echo "Found Splice straggler. Stopping it." && for pid in ${splice_pids9[@]}; do kill -${SIG} $(echo ${pid}); done
[[ -n ${zoo_pids9[0]} ]] && echo "Found ZooKeeper straggler. Stopping it." && for pid in ${zoo_pids9[@]}; do kill -${SIG} $(echo ${pid}); done
