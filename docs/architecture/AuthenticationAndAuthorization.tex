\documentclass{article}
\usepackage[margin=1.25in]{geometry}
\usepackage{fancyhdr}
\pagestyle{fancy}
\lhead{} \rhead{}
\chead{Splice Machine Technical Design Document}
\lfoot{Splice Machine, Inc. Proprietary and Confidential}
\cfoot{}
\rfoot{\thepage\\}

\begin{document}

\title{Authentication and Authorization}
\author{John Leach}
\maketitle
\makeauthor
\thispagestyle{fancy}

\section{Revision History}
\begin{enumerate}
  \item 7/3/2014 - (JL) Initial version
  \item 7/25/2014 - (GD) Minor updates to impact, etc.
\end{enumerate}

\section{Background}
Transactional and Analytical databases are required to provide an
authentication and authorization mechanism.

\section{Requirements}

\subsection{P0 Requirements}
\begin{itemize}
  \item Basic Authentication/Authorization as provided by Apache Derby's 10.9 release
  \item Authentication using external service (i.e. LDAP)
  \item An option for no authentication
\end{itemize}

\subsection{P1 Requirements}
\begin{itemize}
  \item Custom Java Class authentication options
\end{itemize}


\section{Design}

\subsection{Authentication}

Authentication is simply resolving whether a user and password combinations
corresponds to a valid user.  However, there are several options for validating
this correct username, password combination.  There are currently 4 types of
authentication mechanism in Splice Machine.

\begin{enumerate}
	\item None: All usernames and password are allowed to connect to database.
	\item Native: Usernames in a database table are validated against their
	encrypted password.
	\item LDAP: Usernames checked against an existing LDAP service.
	\item Custom: Custom Java Class provided to perform authentication against the
	database.
\end{enumerate}

\subsubsection{None}
An open database that will allow each user to authenticate against the database
can be configured by setting the following configuration.

\begin{enumerate}
	\item splice.authentication=NONE
\end{enumerate}

This is not recommended for production use.


\subsubsection{Native (default)}
This approach to authentication utilizes the sys.sysusers table in the splice
schema.  The password is encrypted using MD5, SHA-256, or
SHA-512 (Default) algorithm.  The 

\begin{enumerate}
	\item splice.authentication=NATIVE
      \item splice.authentication.native.algorithm=MD5,SHA-256,SHA-512(Default)
\end{enumerate}

Default user:  \emph{splice}	
Default password: \emph{admin}

Using Native mode, you log in using a modified connection string:

\texttt{splice> connect 'jdbc:derby://localhost:1527/splicedb;user=\emph{user};password=\emph{password}'}

Therefore the administrative login is as follows:

\texttt{splice> connect 'jdbc:derby://localhost:1527/splicedb;user=splice;password=admin'}




\subsubsection{LDAP}
This approach to authentication uses an external LDAP server. To enable this mode, change the property value of splice.authentication to LDAP in splice configuration file under structured_derby/src/main/resources/splice-site.xml 

An embedded LDAP server will run in maven after LDAP mode is enabled, for unit test purposes.

\begin{enumerate}
	\item splice.authentication=LDAP
	\item splice.authentication.ldap.server=localhost:10389 (Default)
	\item splice.authentication.ldap.searchAuthDN
	\item splice.authentication.ldap.searchAuthPW
	\item splice.authentication.ldap.searchBase
	\item splice.authentication.ldap.searchFilter
\end{enumerate}

\subsubsection{Custom}

The custom authentication
configuration allows for any
class provided by the customer
that implements org.apache.derby.authentication.UserAuthenticator
to be applied as long as the following configuration is set.

\begin{enumerate}
	\item splice.authentication=CUSTOM
	\item	splice.authentication.custom.provider=com.splicemachine.derby.authentication.SpliceUserAuthentication (Default)
\end{enumerate}

The interface is extremely simple and requires a developer to implement the
single method:

boolean	authenticateUser(String userName,String userPassword,String
databaseName,Properties info) throws SQLException;

\subsubsection{Splice Scripts}

We currently ship sqlshell.sh (two versions - one for standalone, the other for clustered).  This version automatically 
logs in the user in our previous mode without specifying a user or password.  Given that we want the default to be with
authorization enabled to NATIVE, propose we have two scripts:

\begin{itemize}
\item sqlshelladmin.sh - hardcodes the user to splice/admin for administrator access
\item sqlshell.sh - does NOT auto connect.  User manually connects, providing user and password
\end{itemize}

We can consider providing the following: 

\begin{itemize}
\item sqlshellnoauth.sh - auto connects, with no user or password (the old sqlshell.sh)
\item sqlshellldap.sh - something special for LDAP connections (TBD)
\end{itemize}


\subsection{Authorization}
Splice Machine will utilize derby authorization syntax and levels. 

\subsubsection{Managing Users}
Users are managed for now using the standard derby syscs calls, for example:

\texttt{splice> call syscs\_util.syscs\_create\_user('username','password');}

\subsubsection{Grant and Revoke}

Splice Machine will utilize derby grant and revoke commands for
authorization levels.  These can be described in the following page.

\url{https://db.apache.org/derby/docs/10.9/devguide/cdevcsecuregrantrevokeaccess.html}

\subsubsection{Roles}

Splice Machine will utilize derby's role based model.  This model is described
in the following page.

\url{https://db.apache.org/derby/docs/10.9/devguide/cdevcsecureroles.html}


\section{Assumptions}

None

\section{Outstanding Issues}

See Upgrade Impacts.  Additionally - what happens if someone wants to "turn off" or "turn on" Authentication after starting the other way around?

\section{Impacts}

\subsection{Impact on QA}

Existing tests need to be updated to reflect an appropriate connection mechanism (splice/admin) or set authentication to NONE

\subsection{Impact on Documentation} 

Existing docs need to be updated if there are references to use of the connection string

\subsection{Impact on Upgrades}

An existing database should be easily migratable to a database enforcing authentication (how?)

\subsection{Other Known Impacts}

See script updates in design above.  Additionally packaging will need to be updated to set the default settings:
\begin{itemize}
\item For standalone, this will go into splice-site.xml.
\item For clustered, we will document how to pass these parameters in with other splice-specific parameters that go into hbase-site.xml
\end{itemize}
 

\end{document}
